<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Simple hybrid CS · FMIFlux.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="FMIFlux.jl logo"/></a><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/overview/">Overview</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../overview/">Overview</a></li><li class="is-active"><a class="tocitem" href>Simple hybrid CS</a></li><li><a class="tocitem" href="../simple_hybrid_ME/">Simple hybrid ME</a></li><li><a class="tocitem" href="../advanced_hybrid_ME/">Advanced hybrid ME</a></li></ul></li><li><a class="tocitem" href="../../library/overview/">Library Functions</a></li><li><a class="tocitem" href="../../related/">Related Publications</a></li><li><a class="tocitem" href="../../contents/">Contents</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Simple hybrid CS</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Simple hybrid CS</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ThummeTo/FMIFlux.jl/blob/master/docs/src/examples/simple_hybrid_CS.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="simpleCS"><a class="docs-heading-anchor" href="#simpleCS">Training a simple Hybrid CS FMU</a><a id="simpleCS-1"></a><a class="docs-heading-anchor-permalink" href="#simpleCS" title="Permalink"></a></h1><p>This example explains how to create and train a CS-Neural FMU.</p><p>First the necessary libraries are loaded and the FMU is prepared for simulation.</p><pre><code class="language-julia">#
# Copyright (c) 2021 Tobias Thummerer, Lars Mikelsons
# Licensed under the MIT license. See LICENSE file in the project root for details.
#

################################## INSTALLATION ####################################################
# (1) Enter Package Manager via     ]
# (2) Install FMI via               add FMI       or   add &quot;https://github.com/ThummeTo/FMI.jl&quot;
# (3) Install FMIFlux via           add FMIFlux   or   add &quot;https://github.com/ThummeTo/FMIFlux.jl&quot;
################################ END INSTALLATION ##################################################

# this example covers creation and training am CS-NeuralFMUs

using FMI
using FMIFlux
using Flux
using DifferentialEquations: Tsit5
import Plots

FMUPath = joinpath(dirname(@__FILE__), &quot;..&quot;, &quot;model&quot;, &quot;SpringPendulumExtForce1D.fmu&quot;)

t_start = 0.0
t_step = 0.01
t_stop = 5.0
tData = t_start:t_step:t_stop

myFMU = fmiLoad(FMUPath)
fmiInstantiate!(myFMU; loggingOn=false)</code></pre><p>Then the FMU is simulated twice. Once with an increased amplitude and inverted phase. This is used as the real Simulation data which the FMU should represent after training. During the simulation the data needed for training is collected.</p><pre><code class="language-julia">fmiSetupExperiment(myFMU, t_start, t_stop)
fmiSetReal(myFMU, &quot;mass_s0&quot;, 1.3)   # increase amplitude, invert phase
fmiEnterInitializationMode(myFMU)
fmiExitInitializationMode(myFMU)



realSimData = fmiSimulate(myFMU, t_start, t_stop; recordValues=[&quot;mass.s&quot;, &quot;mass.v&quot;, &quot;mass.a&quot;], setup=false, saveat=tData)
fmiPlot(realSimData)

fmiReset(myFMU)
fmiSetupExperiment(myFMU, t_start, t_stop)
fmiEnterInitializationMode(myFMU)
fmiExitInitializationMode(myFMU)

fmuSimData = fmiSimulate(myFMU, t_start, t_stop; recordValues=[&quot;mass.s&quot;, &quot;mass.v&quot;, &quot;mass.a&quot;], setup=false, saveat=tData)
fmiPlot(fmuSimData)</code></pre><p>Before the training can start the loss and callback functions are defined.</p><pre><code class="language-julia">######

extF = zeros(length(tData)) # no external force
posData = fmi2SimulationResultGetValues(realSimData, &quot;mass.s&quot;)
velData = fmi2SimulationResultGetValues(realSimData, &quot;mass.v&quot;)
accData = fmi2SimulationResultGetValues(realSimData, &quot;mass.a&quot;)

# loss function for training
function losssum()
    solution = problem(t_step; inputs=extF)

    accNet = collect(data[2] for data in solution)
    #velNet = collect(data[3] for data in solution)

    Flux.Losses.mse(accNet, accData) #+ Flux.Losses.mse(velNet, velData)
end

# callback function for training
global iterCB = 0
function callb()
    global iterCB += 1

    if iterCB % 10 == 1
        avg_ls = losssum()
        @info &quot;Loss: $(round(avg_ls, digits=5))&quot;
    end
end</code></pre><p>After that the net is created and trained.</p><pre><code class="language-julia"># NeuralFMU setup
numInputs = length(myFMU.modelDescription.inputValueReferences)
numOutputs = length(myFMU.modelDescription.outputValueReferences)

net = Chain(inputs -&gt; fmiInputDoStepCSOutput(myFMU, t_step, inputs),
            Dense(numOutputs, 16, tanh),
            Dense(16, 16, tanh),
            Dense(16, numOutputs))

problem = CS_NeuralFMU(myFMU, net, (t_start, t_stop); saveat=tData)
solutionBefore = problem(t_step; inputs=extF)

# train it ...
p_net = Flux.params(problem)

optim = ADAM()
Flux.train!(losssum, p_net, Iterators.repeated((), 300), optim; cb=callb) # Feel free to increase training steps or epochs for better results</code></pre><p>And the results are plotted.</p><pre><code class="language-julia">###### plot results a
solutionAfter = problem(t_step; inputs=extF)
fig = Plots.plot(xlabel=&quot;t [s]&quot;, ylabel=&quot;mass acceleration [m s^-2]&quot;, linewidth=2,
    xtickfontsize=12, ytickfontsize=12,
    xguidefontsize=12, yguidefontsize=12,
    legendfontsize=12, legend=:bottomright)
Plots.plot!(fig, tData, fmi2SimulationResultGetValues(fmuSimData, &quot;mass.a&quot;), label=&quot;FMU&quot;, linewidth=2)
Plots.plot!(fig, tData, accData, label=&quot;reference&quot;, linewidth=2)
Plots.plot!(fig, tData, collect(data[2] for data in solutionAfter), label=&quot;NeuralFMU&quot;, linewidth=2)
Plots.savefig(fig, &quot;exampleResult_a.pdf&quot;)

fmiUnload(myFMU)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../overview/">« Overview</a><a class="docs-footer-nextpage" href="../simple_hybrid_ME/">Simple hybrid ME »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 7 October 2021 07:44">Thursday 7 October 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
